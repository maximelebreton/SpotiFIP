"use strict";var spotifyApi="http://ws.spotify.com/search/1/track.json?q=",fipApi="http://kimonolabs.com/api/7s1d5xz8?apikey=bfb617c617700d2b984e1b58cce5c544",App=angular.module("spotiFipApp",["ngResource","ngSanitize","ui.bootstrap"]);App.directive("onFinishRender",["$timeout",function(a){return{restrict:"A",link:function(b,c,d){b.$last===!0&&a(function(){b.$emit(d.onFinishRender)},1500)}}}]),App.controller("DatepickerCtrl",["$rootScope","$scope","$filter",function(a,b,c){b.today=function(){b.dt=new Date},b.today(),b.showWeeks=!0,b.toggleWeeks=function(){b.showWeeks=!b.showWeeks},b.clear=function(){b.dt=null},b.changed=function(){a.startDate=c("date")(b.dt,"yyyy-MM-dd"),console.log("Time changed to: "+b.dt)},a.$on("startingEvent",function(){b.changed(),console.log(a.startDate)}),b.toggleMin=function(){b.minDate=b.minDate?null:new Date},b.toggleMin(),b.open=function(a){a.preventDefault(),a.stopPropagation(),b.opened=!0},b.dateOptions={"year-format":"'yy'","starting-day":1}}]),App.controller("TimepickerCtrl",["$rootScope","$scope","$filter",function(a,b,c){b.mytime=new Date,b.hstep=1,b.mstep=1,b.changed=function(){console.log("Time changed to: "+b.mytime),a.startHour=c("date")(b.mytime,"H")},b.clear=function(){b.mytime=null},a.$on("startingEvent",function(){b.changed()})}]),App.controller("MainCtrl",["$rootScope","$scope","$http","$sce","$filter","$timeout",function(a,b,c,d,e,f){a.startDate=e("date")(new Date,"yyyy-MM-dd"),a.startHour=e("date")(new Date,"H"),b.tryNumbers=3,b.start=function(d){b.loadingValue=100,d?(console.log("retry"),b.loadingType="warning",b.loadingMessage="Tentative de reconnexion avec FIP... ("+b.tryNumbers+")"):(b.loadingType="info",b.loadingMessage="Connexion avec FIP..."),a.$emit("startingEvent"),b.loading=!0,b.playlist=[],console.log(a.startDate),c.jsonp(fipApi+"&start_hour="+a.startHour+"&start_date="+a.startDate+"&callback=JSON_CALLBACK").success(function(a){b.tryNumbers=3,b.fipDatas=a.results.collection1,b.loadingType="success",b.loadingMessage="Connexion avec Spotify...",angular.forEach(b.fipDatas,function(a,d){var e=0;c.get(spotifyApi+a.track.replace(/[`~!@#$%^&*()_|+\-=?;:'",.<>\{\}\[\]\\\/]/gi,"")+" "+a.artist.replace(/[`~!@#$%^&*()_|+\-=?;:'",.<>\{\}\[\]\\\/]/gi,"")).then(function(c){if(a.spotifyDatas=c.data.tracks,b.loadingType="success",b.loadingMessage="Terminé",a.spotifyDatas.length){var d=!0;angular.forEach(a.spotifyDatas,function(b,c){e=c,d&&(b.album.name.match(new RegExp(a.album,"gi"))?(a.spotify=a.spotifyDatas[c],d=!1):a.spotify=a.spotifyDatas[0])}),b.playlist.push(a.spotify.href),a.spotify.trackEmbedSrc="https://embed.spotify.com/?uri="+a.spotify.href}})})}).error(function(){f(function(){b.loadingType="danger",b.loadingMessage="Erreur de connexion...",0==b.tryNumbers&&(b.loadingMessage="Hum... c'est embarrassant ! Relancez votre recherche, ou signalez moi le problème via Github."),f(function(){b.tryNumbers>0&&(console.log(),b.start(!0),b.tryNumbers--)},1500)},1500)}),b.$on("test",function(){console.log("ready !"),b.loading=!1,b.ready=!0,b.playlistHref="https://embed.spotify.com/?uri=spotify:trackset:FIP – "+a.startDate+" – "+a.startHour+"h-"+(a.startHour+1)+"h:"+b.playlist.join().replace(new RegExp("spotify:track:","g"),"")})}}]).config(["$sceDelegateProvider",function(a){a.resourceUrlWhitelist(["self","https://embed.spotify.com/**"]),a.resourceUrlBlacklist([])}]);