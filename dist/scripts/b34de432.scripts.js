"use strict";var spotifyApi="http://ws.spotify.com/search/1/track.json?q=",fipApi="https://www.kimonolabs.com/api/ondemand/9qx1un9y?apikey=bfb617c617700d2b984e1b58cce5c544",weatherApi="http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20weather.forecast%20where%20woeid%3D23424819%20and%20u%3D%22c%22%20&format=json&callback=",App=angular.module("spotiFipApp",["ngResource","ngSanitize","ui.bootstrap"]);App.directive("onFinishRender",["$timeout",function(a){return{restrict:"A",link:function(b,c,d){b.$last===!0&&a(function(){b.$emit(d.onFinishRender)},1500)}}}]),App.controller("DatepickerCtrl",["$rootScope","$scope","$filter",function(a,b,c){a.startDate=c("date")(new Date,"yyyy-MM-dd"),b.today=function(){b.dt=new Date},b.today(),b.showWeeks=!0,b.toggleWeeks=function(){b.showWeeks=!b.showWeeks},b.clear=function(){b.dt=null},b.changed=function(){a.startDate=c("date")(b.dt,"yyyy-MM-dd")},a.$on("startingEvent",function(){b.changed()}),b.minDate=c("date")(new Date((new Date).getTime()-11232e5),"yyyy-MM-dd"),b.maxDate=c("date")(new Date,"yyyy-MM-dd"),b.open=function(a){a.preventDefault(),a.stopPropagation(),b.opened=!0},b.dateOptions={"year-format":"'yy'","starting-day":1}}]),App.controller("TimepickerCtrl",["$rootScope","$scope","$filter",function(a,b,c){a.startHour=c("date")(new Date,"H"),b.mytime=new Date,b.hstep=1,b.mstep=1,b.changed=function(){a.startHour=c("date")(b.mytime,"H")},b.clear=function(){b.mytime=null},a.$on("startingEvent",function(){b.changed()})}]),App.controller("MainCtrl",["$rootScope","$scope","$http","$sce","$filter","$timeout","$q",function(a,b,c,d,e,f,g){b.tryNumbers=3,b.start=function(d){b.loadingValue=100,b.noResults=!1,d?(b.loadingType="warning",b.loadingMessage="Tentative de reconnexion avec FIP... ("+b.tryNumbers+")"):(b.loadingType="info",b.loadingMessage="Connexion avec FIP..."),f(function(){"success"!=b.loadingType&&(b.loadingMessage="Il va falloir attendre un petit peu...")},3e3),f(function(){"success"!=b.loadingType&&(b.loadingMessage="Le temps que le gars de FIP discute avec celui de Spotify...")},6e3),f(function(){"success"!=b.loadingType&&(b.loadingMessage="En attendant, je vous propose de faire un point météo !",c.get(weatherApi).then(function(a){b.temperature=a.data.query.results.channel.item.forecast[0]}))},11e3),f(function(){"success"!=b.loadingType&&(b.loadingMessage="Pour la france, les temperatures vont de "+b.temperature.low+"°C pour les minimales, et "+b.temperature.high+"°C pour les maximales !")},14e3),a.$emit("startingEvent"),b.loading=!0,b.playlist=[],c.jsonp(fipApi+"&start_hour="+a.startHour+"&start_date="+a.startDate+"&callback=JSON_CALLBACK").success(function(d){if("failure"==d.lastrunstatus)return b.noResults=!0,void(b.loading=!1);b.tryNumbers=3,b.fipDatas=d.results.collection1,b.loadingType="success",b.loadingMessage="Connexion avec Spotify...";var e=(g.defer(),[]);angular.forEach(b.fipDatas,function(a,d){var f=0;e.push(c.get(spotifyApi+a.track.replace(/[`~!@#$%^&*()_|+\-=?;:'",.<>\{\}\[\]\\\/]/gi,"")+" "+a.artist.replace(/[`~!@#$%^&*()_|+\-=?;:'",.<>\{\}\[\]\\\/]/gi,"")).then(function(c){if(a.spotifyDatas=c.data.tracks,b.loadingType="success",b.loadingMessage="Terminé",a.spotifyDatas.length){var d=!0;angular.forEach(a.spotifyDatas,function(b,c){f=c,d&&(b.album.name.match(new RegExp(a.album,"gi"))?(a.spotify=a.spotifyDatas[c],d=!1):a.spotify=a.spotifyDatas[0])}),b.playlist.push(a.spotify.href),a.spotify.trackEmbedSrc="https://embed.spotify.com/?uri="+a.spotify.href}}))}),g.all(e).then(function(c){b.loading=!1,b.ready=!0,b.playlistHref="https://embed.spotify.com/?uri=spotify:trackset:FIP – "+a.startDate+" – "+a.startHour+"h-"+(parseInt(a.startHour)+1)+"h:"+b.playlist.join().replace(new RegExp("spotify:track:","g"),"")})}).error(function(a,c,d,e){f(function(){b.loadingType="danger",b.loadingMessage="Erreur de connexion...",0==b.tryNumbers&&(b.loadingMessage="Hum... c'est embarrassant ! Relancez votre recherche, ou signalez moi le problème via Github."),f(function(){b.tryNumbers>0&&(b.start(!0),b.tryNumbers--)},1500)},1500)})}}]).config(["$sceDelegateProvider",function(a){a.resourceUrlWhitelist(["self","https://embed.spotify.com/**"]),a.resourceUrlBlacklist([])}]);